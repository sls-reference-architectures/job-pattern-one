service: job-pattern-one

frameworkVersion: ^3

configValidationMode: error

provider:
  architecture: arm64
  deploymentBucket:
    name: com.reference-architecture.deploys
    maxPreviousDeploymentArtifacts: 5
    serverSideEncryption: AES256
  environment:
    TABLE_NAME: ${self:custom.tableName}
    EVENT_BUS_NAME: ${self:custom.eventBusName}
  logRetentionInDays: 7
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'dev'}
  tags:
    lumigo:auto-trace: 'true'

functions:
  createJob:
    handler: jobs/handlers/createJob.default
    events:
    - httpApi:
        method: POST
        path: /jobs
    iamRoleStatements:
    - Effect: Allow
      Action: dynamodb:PutItem
      Resource: !GetAtt JobsTable.Arn
  
  onDbStreamEvent:
    handler: jobs/handlers/onDbStreamEvent.default
    events:
    - stream:
        type: dynamodb
        arn: !GetAtt JobsTable.StreamArn
        batchSize: 10
    iamRoleStatements:
    - Effect: Allow
      Action: events:PutEvents
      Resource: !GetAtt JobsEventBus.Arn

  onJobCreated:
    handler: jobs/handlers/onJobCreated.default
    events:
    - eventBridge:
        eventBus: !GetAtt JobsEventBus.Arn
        pattern:
          source:
          - job
          detail-type:
          - create
    # iamRoleStatements:
    # - Effect: Allow
    #   Action: states:StartExecution
    #   Resource: !Ref TranslationStateMachine

custom:
  esbuild:
    minify: true
  eventBusName: jobs-${sls:stage}
  prune:
    automatic: true
    number: 1
  tableName: jobs-${sls:stage}

resources:
  Resources:
    JobsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        BillingMode: PAY_PER_REQUEST
        TableName: ${self:custom.tableName}
        ContributorInsightsSpecification:
          Enabled: true
        KeySchema:
        - AttributeName: id
          KeyType: HASH
        AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: True
    JobsEventBus:
      Type: AWS::Events::EventBus
      Properties:
        Name: ${self:custom.eventBusName}

# stepFunctions:
#   stateMachines:
#     TranslateStateMachine:
#       name: TranslateStateMachine
#       definition:
#         StartAt:
      

plugins:
- serverless-esbuild
- serverless-iam-roles-per-function
- serverless-deployment-bucket
- serverless-prune-plugin
- serverless-step-functions